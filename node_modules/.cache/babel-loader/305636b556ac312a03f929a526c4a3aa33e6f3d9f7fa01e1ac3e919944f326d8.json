{"ast":null,"code":"import { refreshToken } from '../API';\nimport { sessionManager } from '../Config/cookies';\n\n// استخراج رسالة الخطأ من استجابة الباك إند\nconst extractErrorMessage = data => {\n  // إذا كان هناك رسالة خطأ مباشرة\n  if (typeof data === 'string') {\n    return data;\n  }\n\n  // إذا كان هناك رسالة خطأ محددة\n  if (data.message) {\n    return data.message;\n  }\n\n  // إذا كان هناك رسالة خطأ باللغة العربية\n  if (data.message_ar) {\n    return data.message_ar;\n  }\n\n  // إذا كان هناك أخطاء في الحقول (Django REST Framework style)\n  if (data.errors) {\n    const errorMessages = [];\n\n    // التعامل مع أخطاء الحقول\n    Object.keys(data.errors).forEach(field => {\n      const fieldErrors = data.errors[field];\n      if (Array.isArray(fieldErrors)) {\n        errorMessages.push(...fieldErrors);\n      } else if (typeof fieldErrors === 'string') {\n        errorMessages.push(fieldErrors);\n      }\n    });\n    if (errorMessages.length > 0) {\n      return errorMessages.join(', ');\n    }\n  }\n\n  // إذا كان هناك أخطاء في الحقول (Flask style)\n  if (data.error) {\n    return data.error;\n  }\n\n  // إذا كان هناك تفاصيل\n  if (data.detail) {\n    return data.detail;\n  }\n\n  // إذا كان هناك قائمة أخطاء\n  if (Array.isArray(data)) {\n    return data.join(', ');\n  }\n\n  // إذا كان هناك رسالة خطأ في non_field_errors (Django)\n  if (data.non_field_errors) {\n    return data.non_field_errors.join(', ');\n  }\n  return null;\n};\n\n// معالجة أخطاء API - استخراج رسالة الخطأ من الباك إند فقط\nexport const handleApiError = error => {\n  var _error$response;\n  console.log('❌ خطأ في API:', error);\n\n  // إذا كان هناك استجابة من الخادم\n  if ((_error$response = error.response) !== null && _error$response !== void 0 && _error$response.data) {\n    const errorMessage = extractErrorMessage(error.response.data);\n    if (errorMessage) {\n      return errorMessage;\n    }\n  }\n\n  // إذا كان هناك رسالة خطأ في error.message\n  if (error.message) {\n    // تجاهل رسائل axios العامة\n    if (!error.message.includes('Network Error') && !error.message.includes('timeout') && !error.message.includes('Request failed')) {\n      return error.message;\n    }\n  }\n\n  // إذا لم يكن هناك استجابة من الخادم\n  if (!error.response) {\n    return 'فشل في الاتصال بالخادم، يرجى التحقق من اتصال الإنترنت';\n  }\n\n  // إذا لم نتمكن من استخراج رسالة خطأ، نعرض رسالة عامة\n  return 'حدث خطأ غير متوقع، يرجى المحاولة مرة أخرى';\n};\n\n// معالجة خطأ 401 (غير مصرح)\nexport const handleUnauthorizedError = async (error, originalRequest, axiosInstance) => {\n  // إذا لم نكن قد حاولنا تحديث التوكن من قبل\n  if (!originalRequest._retry) {\n    originalRequest._retry = true;\n    try {\n      const session = sessionManager.restoreSession();\n      const refreshTokenValue = session === null || session === void 0 ? void 0 : session.refreshToken;\n      if (refreshTokenValue) {\n        console.log('🔄 محاولة تحديث التوكن...');\n\n        // طلب تحديث التوكن\n        const response = await refreshToken(refreshTokenValue);\n\n        // تحديث التوكنز في الكوكيز\n        sessionManager.saveSession({\n          access: response.access,\n          refresh: response.refresh,\n          user: session.userData\n        });\n\n        // إعادة الطلب الأصلي مع التوكن الجديد\n        originalRequest.headers.Authorization = `Bearer ${response.access}`;\n        console.log('✅ تم تحديث التوكن وإعادة الطلب');\n        return axiosInstance(originalRequest);\n      }\n    } catch (refreshError) {\n      console.log('❌ فشل تحديث التوكن:', refreshError);\n      handleRefreshTokenFailure();\n    }\n  }\n\n  // إذا فشل التحديث أو تمت المحاولة من قبل\n  handleRefreshTokenFailure();\n  return Promise.reject(error);\n};\n\n// معالجة فشل تحديث التوكن\nexport const handleRefreshTokenFailure = () => {\n  console.log('🧹 حذف الجلسة بسبب فشل تحديث التوكن');\n  sessionManager.clearSession();\n\n  // إرسال حدث لحذف الجلسة\n  window.dispatchEvent(new CustomEvent('sessionExpired'));\n};\n\n// معالجة أخطاء عامة\nexport const handleError = error => {\n  var _error$response2;\n  console.log('❌ خطأ في الطلب:', error);\n  if (((_error$response2 = error.response) === null || _error$response2 === void 0 ? void 0 : _error$response2.status) === 401) {\n    handleRefreshTokenFailure();\n  }\n  return Promise.reject(error);\n};\n\n// هذا القديم قبل ما تنقلي مكان الملف من config\n// import { refreshToken } from '../API/Auth';\n// import { tokenManager, sessionManager } from './cookies';\n\n// // معالجة خطأ 401 (غير مصرح)\n// export const handleUnauthorizedError = async (error, originalRequest, axiosInstance) => {\n//   // إذا لم نكن قد حاولنا تحديث التوكن من قبل\n//   if (!originalRequest._retry) {\n//     originalRequest._retry = true;\n\n//     try {\n//       const refreshTokenValue = tokenManager.getRefreshToken();\n//       if (refreshTokenValue) {\n//         console.log('🔄 محاولة تحديث التوكن...');\n\n//         // طلب تحديث التوكن\n//         const response = await refreshToken(refreshTokenValue);\n\n//         // تحديث التوكنز في الكوكيز\n//         tokenManager.updateTokens(response.access, response.refresh);\n\n//         // إعادة الطلب الأصلي مع التوكن الجديد\n//         originalRequest.headers.Authorization = `Bearer ${response.access}`;\n//         console.log('✅ تم تحديث التوكن وإعادة الطلب');\n\n//         return axiosInstance(originalRequest);\n//       }\n//     } catch (refreshError) {\n//       console.log('❌ فشل تحديث التوكن:', refreshError);\n//       handleRefreshTokenFailure();\n//     }\n//   }\n\n//   // إذا فشل التحديث أو تمت المحاولة من قبل\n//   handleRefreshTokenFailure();\n//   return Promise.reject(error);\n// };\n\n// // معالجة فشل تحديث التوكن\n// export const handleRefreshTokenFailure = () => {\n//   console.log('🧹 حذف الجلسة بسبب فشل تحديث التوكن');\n//   sessionManager.clearSession();\n\n//   // إرسال حدث لحذف الجلسة\n//   window.dispatchEvent(new CustomEvent('sessionExpired'));\n// };\n\n// // معالجة أخطاء عامة\n// export const handleError = (error) => {\n//   console.log('❌ خطأ في الطلب:', error);\n\n//   if (error.response?.status === 401) {\n//     handleRefreshTokenFailure();\n//   }\n\n//   return Promise.reject(error);\n// };","map":{"version":3,"names":["refreshToken","sessionManager","extractErrorMessage","data","message","message_ar","errors","errorMessages","Object","keys","forEach","field","fieldErrors","Array","isArray","push","length","join","error","detail","non_field_errors","handleApiError","_error$response","console","log","response","errorMessage","includes","handleUnauthorizedError","originalRequest","axiosInstance","_retry","session","restoreSession","refreshTokenValue","saveSession","access","refresh","user","userData","headers","Authorization","refreshError","handleRefreshTokenFailure","Promise","reject","clearSession","window","dispatchEvent","CustomEvent","handleError","_error$response2","status"],"sources":["C:/Users/shaza/Desktop/test for NO/src/Utils/errorHandler.js"],"sourcesContent":["import { refreshToken } from '../API';\r\nimport { sessionManager } from '../Config/cookies';\r\n\r\n// استخراج رسالة الخطأ من استجابة الباك إند\r\nconst extractErrorMessage = (data) => {\r\n  // إذا كان هناك رسالة خطأ مباشرة\r\n  if (typeof data === 'string') {\r\n    return data;\r\n  }\r\n  \r\n  // إذا كان هناك رسالة خطأ محددة\r\n  if (data.message) {\r\n    return data.message;\r\n  }\r\n  \r\n  // إذا كان هناك رسالة خطأ باللغة العربية\r\n  if (data.message_ar) {\r\n    return data.message_ar;\r\n  }\r\n  \r\n  // إذا كان هناك أخطاء في الحقول (Django REST Framework style)\r\n  if (data.errors) {\r\n    const errorMessages = [];\r\n    \r\n    // التعامل مع أخطاء الحقول\r\n    Object.keys(data.errors).forEach(field => {\r\n      const fieldErrors = data.errors[field];\r\n      if (Array.isArray(fieldErrors)) {\r\n        errorMessages.push(...fieldErrors);\r\n      } else if (typeof fieldErrors === 'string') {\r\n        errorMessages.push(fieldErrors);\r\n      }\r\n    });\r\n    \r\n    if (errorMessages.length > 0) {\r\n      return errorMessages.join(', ');\r\n    }\r\n  }\r\n  \r\n  // إذا كان هناك أخطاء في الحقول (Flask style)\r\n  if (data.error) {\r\n    return data.error;\r\n  }\r\n  \r\n  // إذا كان هناك تفاصيل\r\n  if (data.detail) {\r\n    return data.detail;\r\n  }\r\n  \r\n  // إذا كان هناك قائمة أخطاء\r\n  if (Array.isArray(data)) {\r\n    return data.join(', ');\r\n  }\r\n  \r\n  // إذا كان هناك رسالة خطأ في non_field_errors (Django)\r\n  if (data.non_field_errors) {\r\n    return data.non_field_errors.join(', ');\r\n  }\r\n  \r\n  return null;\r\n};\r\n\r\n// معالجة أخطاء API - استخراج رسالة الخطأ من الباك إند فقط\r\nexport const handleApiError = (error) => {\r\n  console.log('❌ خطأ في API:', error);\r\n  \r\n  // إذا كان هناك استجابة من الخادم\r\n  if (error.response?.data) {\r\n    const errorMessage = extractErrorMessage(error.response.data);\r\n    if (errorMessage) {\r\n      return errorMessage;\r\n    }\r\n  }\r\n  \r\n  // إذا كان هناك رسالة خطأ في error.message\r\n  if (error.message) {\r\n    // تجاهل رسائل axios العامة\r\n    if (!error.message.includes('Network Error') && \r\n        !error.message.includes('timeout') &&\r\n        !error.message.includes('Request failed')) {\r\n      return error.message;\r\n    }\r\n  }\r\n  \r\n  // إذا لم يكن هناك استجابة من الخادم\r\n  if (!error.response) {\r\n    return 'فشل في الاتصال بالخادم، يرجى التحقق من اتصال الإنترنت';\r\n  }\r\n  \r\n  // إذا لم نتمكن من استخراج رسالة خطأ، نعرض رسالة عامة\r\n  return 'حدث خطأ غير متوقع، يرجى المحاولة مرة أخرى';\r\n};\r\n\r\n// معالجة خطأ 401 (غير مصرح)\r\nexport const handleUnauthorizedError = async (error, originalRequest, axiosInstance) => {\r\n  // إذا لم نكن قد حاولنا تحديث التوكن من قبل\r\n  if (!originalRequest._retry) {\r\n    originalRequest._retry = true;\r\n\r\n    try {\r\n      const session = sessionManager.restoreSession();\r\n      const refreshTokenValue = session?.refreshToken;\r\n      \r\n      if (refreshTokenValue) {\r\n        console.log('🔄 محاولة تحديث التوكن...');\r\n        \r\n        // طلب تحديث التوكن\r\n        const response = await refreshToken(refreshTokenValue);\r\n        \r\n        // تحديث التوكنز في الكوكيز\r\n        sessionManager.saveSession({\r\n          access: response.access,\r\n          refresh: response.refresh,\r\n          user: session.userData\r\n        });\r\n        \r\n        // إعادة الطلب الأصلي مع التوكن الجديد\r\n        originalRequest.headers.Authorization = `Bearer ${response.access}`;\r\n        console.log('✅ تم تحديث التوكن وإعادة الطلب');\r\n        \r\n        return axiosInstance(originalRequest);\r\n      }\r\n    } catch (refreshError) {\r\n      console.log('❌ فشل تحديث التوكن:', refreshError);\r\n      handleRefreshTokenFailure();\r\n    }\r\n  }\r\n\r\n  // إذا فشل التحديث أو تمت المحاولة من قبل\r\n  handleRefreshTokenFailure();\r\n  return Promise.reject(error);\r\n};\r\n\r\n// معالجة فشل تحديث التوكن\r\nexport const handleRefreshTokenFailure = () => {\r\n  console.log('🧹 حذف الجلسة بسبب فشل تحديث التوكن');\r\n  sessionManager.clearSession();\r\n  \r\n  // إرسال حدث لحذف الجلسة\r\n  window.dispatchEvent(new CustomEvent('sessionExpired'));\r\n};\r\n\r\n// معالجة أخطاء عامة\r\nexport const handleError = (error) => {\r\n  console.log('❌ خطأ في الطلب:', error);\r\n  \r\n  if (error.response?.status === 401) {\r\n    handleRefreshTokenFailure();\r\n  }\r\n  \r\n  return Promise.reject(error);\r\n}; \r\n\r\n\r\n// هذا القديم قبل ما تنقلي مكان الملف من config\r\n// import { refreshToken } from '../API/Auth';\r\n// import { tokenManager, sessionManager } from './cookies';\r\n\r\n// // معالجة خطأ 401 (غير مصرح)\r\n// export const handleUnauthorizedError = async (error, originalRequest, axiosInstance) => {\r\n//   // إذا لم نكن قد حاولنا تحديث التوكن من قبل\r\n//   if (!originalRequest._retry) {\r\n//     originalRequest._retry = true;\r\n\r\n//     try {\r\n//       const refreshTokenValue = tokenManager.getRefreshToken();\r\n//       if (refreshTokenValue) {\r\n//         console.log('🔄 محاولة تحديث التوكن...');\r\n        \r\n//         // طلب تحديث التوكن\r\n//         const response = await refreshToken(refreshTokenValue);\r\n        \r\n//         // تحديث التوكنز في الكوكيز\r\n//         tokenManager.updateTokens(response.access, response.refresh);\r\n        \r\n//         // إعادة الطلب الأصلي مع التوكن الجديد\r\n//         originalRequest.headers.Authorization = `Bearer ${response.access}`;\r\n//         console.log('✅ تم تحديث التوكن وإعادة الطلب');\r\n        \r\n//         return axiosInstance(originalRequest);\r\n//       }\r\n//     } catch (refreshError) {\r\n//       console.log('❌ فشل تحديث التوكن:', refreshError);\r\n//       handleRefreshTokenFailure();\r\n//     }\r\n//   }\r\n\r\n//   // إذا فشل التحديث أو تمت المحاولة من قبل\r\n//   handleRefreshTokenFailure();\r\n//   return Promise.reject(error);\r\n// };\r\n\r\n// // معالجة فشل تحديث التوكن\r\n// export const handleRefreshTokenFailure = () => {\r\n//   console.log('🧹 حذف الجلسة بسبب فشل تحديث التوكن');\r\n//   sessionManager.clearSession();\r\n  \r\n//   // إرسال حدث لحذف الجلسة\r\n//   window.dispatchEvent(new CustomEvent('sessionExpired'));\r\n// };\r\n\r\n// // معالجة أخطاء عامة\r\n// export const handleError = (error) => {\r\n//   console.log('❌ خطأ في الطلب:', error);\r\n  \r\n//   if (error.response?.status === 401) {\r\n//     handleRefreshTokenFailure();\r\n//   }\r\n  \r\n//   return Promise.reject(error);\r\n// }; "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}